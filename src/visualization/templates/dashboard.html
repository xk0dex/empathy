<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ù Proyecto Empathy - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .metric-large {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }

        .metric-small {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Estados de salud */
        .excellent { background: linear-gradient(135deg, #56ab2f, #a8e6cf); color: white; }
        .good { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .fair { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .poor { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .critical { background: linear-gradient(135deg, #8e44ad, #2c3e50); color: white; }

        .recommendations {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 5px solid #f39c12;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .warning {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
            border-left: 5px solid #e74c3c;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .member-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .member-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .member-stats {
            font-size: 0.9em;
            color: #666;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-critical { background: #e74c3c; }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .metric-large {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Proyecto Empathy</h1>
            <p>El smartwatch para la salud de tu equipo de desarrollo</p>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Actualizar Datos</button>
        </div>

        <div id="loading" class="loading">
            <p>üìä Cargando an√°lisis del equipo...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- M√©tricas principales -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>üåü Salud General del Equipo</h3>
                    <div id="overall-health" class="metric-large">
                        --
                    </div>
                </div>

                <div class="card">
                    <h3>üí¨ An√°lisis de Comunicaci√≥n</h3>
                    <div class="metric-small">
                        <span class="metric-label">Score General:</span>
                        <span id="communication-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Sentimientos Positivos:</span>
                        <span id="positive-ratio" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Sentimientos Negativos:</span>
                        <span id="negative-ratio" class="metric-value">--</span>
                    </div>
                </div>

                <div class="card">
                    <h3>ü§ù An√°lisis de Colaboraci√≥n</h3>
                    <div class="metric-small">
                        <span class="metric-label">Score de Colaboraci√≥n:</span>
                        <span id="collaboration-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Miembros del Equipo:</span>
                        <span id="team-size" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Densidad de Red:</span>
                        <span id="network-density" class="metric-value">--</span>
                    </div>
                </div>

                <div class="card">
                    <h3>üß† Distribuci√≥n de Conocimiento</h3>
                    <div class="metric-small">
                        <span class="metric-label">Score de Distribuci√≥n:</span>
                        <span id="knowledge-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Silos Detectados:</span>
                        <span id="silos-count" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Participaci√≥n en Reviews:</span>
                        <span id="review-participation" class="metric-value">--</span>
                    </div>
                </div>
            </div>

            <!-- Gr√°ficos -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>üìà Distribuci√≥n de Sentimientos</h3>
                    <div class="chart-container">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üï∏Ô∏è Red de Colaboraci√≥n</h3>
                    <div class="chart-container">
                        <canvas id="collaborationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Miembros del equipo -->
            <div class="card">
                <h3>üë• Miembros del Equipo</h3>
                <div id="team-members" class="member-grid">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>

            <!-- Alertas y recomendaciones -->
            <div id="recommendations-container">
                <!-- Se llenar√°n din√°micamente -->
            </div>

            <!-- Silos de conocimiento -->
            <div id="silos-container">
                <!-- Se llenar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <script>
        let sentimentChart = null;
        let collaborationChart = null;

        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                updateDashboard(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error cargando datos del an√°lisis');
            }
        }

        function updateDashboard(data) {
            updateSummaryMetrics(data.summary || {});
            updateSentimentAnalysis(data.sentiment_analysis || {});
            updateCollaborationAnalysis(data.collaboration_analysis || {});
            updateTeamMembers(data.collaboration_analysis?.member_metrics || []);
            updateRecommendations(data.recommendations || []);
            updateKnowledgeSilos(data.collaboration_analysis?.knowledge_silos || []);
        }

        function updateSummaryMetrics(summary) {
            const healthElement = document.getElementById('overall-health');
            const healthStatus = summary.health_status || 'üòê Regular';
            const healthScore = summary.overall_team_health || 0;
            
            healthElement.textContent = healthStatus;
            healthElement.className = 'metric-large ' + getHealthClass(healthScore);
            
            document.getElementById('communication-score').textContent = 
                (summary.communication_health || 0).toFixed(2);
            document.getElementById('collaboration-score').textContent = 
                (summary.collaboration_health || 0).toFixed(2);
            document.getElementById('knowledge-score').textContent = 
                (summary.knowledge_distribution || 0).toFixed(2);
        }

        function updateSentimentAnalysis(sentimentData) {
            const metrics = sentimentData.overall_metrics || {};
            
            document.getElementById('positive-ratio').textContent = 
                ((metrics.positive_ratio || 0) * 100).toFixed(1) + '%';
            document.getElementById('negative-ratio').textContent = 
                ((metrics.negative_ratio || 0) * 100).toFixed(1) + '%';
            
            // Crear gr√°fico de sentimientos
            createSentimentChart(metrics);
        }

        function updateCollaborationAnalysis(collaborationData) {
            const teamMetrics = collaborationData.team_health_metrics || {};
            const networkMetrics = collaborationData.collaboration_network || {};
            
            document.getElementById('team-size').textContent = 
                teamMetrics.team_size || '0';
            document.getElementById('network-density').textContent = 
                (networkMetrics.network_density || 0).toFixed(2);
            document.getElementById('review-participation').textContent = 
                ((teamMetrics.review_participation_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('silos-count').textContent = 
                (collaborationData.knowledge_silos || []).length;
        }

        function updateTeamMembers(memberMetrics) {
            const container = document.getElementById('team-members');
            container.innerHTML = '';
            
            memberMetrics.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                const healthClass = getHealthClass(member.collaboration_score);
                
                memberCard.innerHTML = `
                    <div class="member-name">
                        <span class="status-indicator ${getStatusClass(member.collaboration_score)}"></span>
                        ${member.member}
                    </div>
                    <div class="member-stats">
                        <div>Score de Colaboraci√≥n: <strong>${member.collaboration_score.toFixed(2)}</strong></div>
                        <div>Commits: <strong>${member.commits_count}</strong></div>
                        <div>PRs: <strong>${member.pr_count}</strong></div>
                        <div>Reviews: <strong>${member.reviews_given}</strong></div>
                    </div>
                `;
                
                container.appendChild(memberCard);
            });
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';
            
            if (recommendations.length > 0) {
                const recDiv = document.createElement('div');
                recDiv.className = 'recommendations';
                
                let html = '<h3>üí° Recomendaciones</h3><ul>';
                recommendations.forEach(rec => {
                    html += `<li>${rec.message}</li>`;
                });
                html += '</ul>';
                
                recDiv.innerHTML = html;
                container.appendChild(recDiv);
            }
        }

        function updateKnowledgeSilos(silos) {
            const container = document.getElementById('silos-container');
            container.innerHTML = '';
            
            if (silos.length > 0) {
                const silosDiv = document.createElement('div');
                silosDiv.className = 'warning';
                
                let html = '<h3>üö® Silos de Conocimiento Detectados</h3>';
                html += `<p>Se detectaron ${silos.length} silos de conocimiento:</p><ul>`;
                
                silos.forEach(silo => {
                    html += `<li><strong>${silo.primary_owner}</strong>: ${silo.files.length} archivos (${(silo.ownership_percentage * 100).toFixed(1)}% ownership) - Riesgo: ${silo.risk_level}</li>`;
                });
                html += '</ul>';
                
                silosDiv.innerHTML = html;
                container.appendChild(silosDiv);
            }
        }

        function createSentimentChart(metrics) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }
            
            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positivo', 'Neutral', 'Negativo'],
                    datasets: [{
                        data: [
                            (metrics.positive_ratio || 0) * 100,
                            (metrics.neutral_ratio || 0) * 100,
                            (metrics.negative_ratio || 0) * 100
                        ],
                        backgroundColor: ['#27ae60', '#95a5a6', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function getHealthClass(score) {
            if (score >= 0.8) return 'excellent';
            if (score >= 0.6) return 'good';
            if (score >= 0.4) return 'fair';
            if (score >= 0.2) return 'poor';
            return 'critical';
        }

        function getStatusClass(score) {
            if (score >= 0.6) return 'status-healthy';
            if (score >= 0.3) return 'status-warning';
            return 'status-critical';
        }

        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            loadData();
        }

        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <p style="color: #e74c3c;">‚ùå ${message}</p>
                <button class="refresh-btn" onclick="refreshData()" style="margin-top: 20px;">
                    üîÑ Reintentar
                </button>
            `;
        }

        // Cargar datos al inicializar
        window.addEventListener('load', loadData);
    </script>
</body>
</html>