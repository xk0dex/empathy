<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ù Proyecto Empathy - Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            color: white;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tooltips para ayuda contextual */
        .help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #6c757d;
            border-radius: 50%;
            color: white;
            text-align: center;
            font-size: 12px;
            line-height: 18px;
            cursor: help;
            position: relative;
        }

        .help-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 1000;
            max-width: 250px;
            white-space: normal;
            width: max-content;
        }

        .help-icon:hover::before {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: #333;
        }

        /* Indicadores de salud por colores */
        .health-excellent { color: #28a745; background: rgba(40, 167, 69, 0.1); }
        .health-good { color: #17a2b8; background: rgba(23, 162, 184, 0.1); }
        .health-fair { color: #ffc107; background: rgba(255, 193, 7, 0.1); }
        .health-poor { color: #dc3545; background: rgba(220, 53, 69, 0.1); }

        .metric-large {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
        }

        .metric-small {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin: 5px 0;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .metric-label {
            font-weight: 500;
            color: #666;
        }

        .metric-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Estados de salud */
        .excellent { background: linear-gradient(135deg, #56ab2f, #a8e6cf); color: white; }
        .good { background: linear-gradient(135deg, #2ecc71, #27ae60); color: white; }
        .fair { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .poor { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; }
        .critical { background: linear-gradient(135deg, #8e44ad, #2c3e50); color: white; }

        .recommendations {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 5px solid #f39c12;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .warning {
            background: linear-gradient(135deg, #f8d7da, #fab1a0);
            border-left: 5px solid #e74c3c;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.2em;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }

        .member-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .member-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .member-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .member-stats {
            font-size: 0.9em;
            color: #666;
        }

        .refresh-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-healthy { background: #27ae60; }
        .status-warning { background: #f39c12; }
        .status-critical { background: #e74c3c; }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .metric-large {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ù Proyecto Empathy</h1>
            <p>El smartwatch para la salud de tu equipo de desarrollo</p>
            <button class="refresh-btn" onclick="refreshData()">üîÑ Actualizar Datos</button>
        </div>

        <div id="loading" class="loading">
            <p>üìä Cargando an√°lisis del equipo...</p>
        </div>

        <div id="dashboard" style="display: none;">
            <!-- M√©tricas principales -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>
                        üåü Salud General del Equipo
                        <span class="help-icon" data-tooltip="M√©trica combinada (0.0-1.0) que incluye comunicaci√≥n, colaboraci√≥n y distribuci√≥n de conocimiento. 0.8+ = Excelente, 0.6-0.8 = Bueno, 0.4-0.6 = Regular, <0.4 = Cr√≠tico">?</span>
                    </h3>
                    <div id="overall-health" class="metric-large">
                        --
                    </div>
                </div>

                <div class="card">
                    <h3>
                        üí¨ An√°lisis de Comunicaci√≥n
                        <span class="help-icon" data-tooltip="Eval√∫a el tono en commits, PRs y reviews. IMPORTANTE: NLP no detecta sarcasmo/iron√≠a. Usar como indicador, no veredicto final.">?</span>
                    </h3>
                    <div class="metric-small">
                        <span class="metric-label">Score General:</span>
                        <span id="communication-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Sentimientos Positivos:</span>
                        <span id="positive-ratio" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Sentimientos Negativos:</span>
                        <span id="negative-ratio" class="metric-value">--</span>
                    </div>
                </div>

                <div class="card">
                    <h3>
                        ü§ù An√°lisis de Colaboraci√≥n
                        <span class="help-icon" data-tooltip="Mide interacci√≥n entre miembros: % PRs con reviews, diversidad de reviewers, respuesta y engagement. 0.8+ = Muy colaborativo, <0.5 = Silos evidentes">?</span>
                    </h3>
                    <div class="metric-small">
                        <span class="metric-label">Score de Colaboraci√≥n:</span>
                        <span id="collaboration-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Miembros del Equipo:</span>
                        <span id="team-size" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Densidad de Red:</span>
                        <span id="network-density" class="metric-value">--</span>
                    </div>
                </div>

                <div class="card">
                    <h3>
                        üß† Distribuci√≥n de Conocimiento
                        <span class="help-icon" data-tooltip="Detecta concentraci√≥n vs distribuci√≥n de expertise. 0.8+ = Muy distribuido, 0.4-0.6 = Algunos silos, <0.4 = Conocimiento muy concentrado (bus factor alto)">?</span>
                    </h3>
                    <div class="metric-small">
                        <span class="metric-label">Score de Distribuci√≥n:</span>
                        <span id="knowledge-score" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Silos Detectados:</span>
                        <span id="silos-count" class="metric-value">--</span>
                    </div>
                    <div class="metric-small">
                        <span class="metric-label">Participaci√≥n en Reviews:</span>
                        <span id="review-participation" class="metric-value">--</span>
                    </div>
                </div>
            </div>

            <!-- Tendencias Hist√≥ricas -->
            <div class="card" style="grid-column: 1 / -1;">
                <h3>
                    üìä Tendencias Hist√≥ricas
                    <span class="help-icon" data-tooltip="Visualiza la evoluci√≥n de m√©tricas del equipo a lo largo del tiempo. Permite detectar patrones, mejoras y deterioros antes de que se conviertan en problemas cr√≠ticos.">?</span>
                </h3>
                <div style="margin-bottom: 20px;">
                    <label for="trend-period" style="margin-right: 10px;">Per√≠odo:</label>
                    <select id="trend-period" onchange="updateTrendPeriod()" style="padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd;">
                        <option value="weekly">√öltimas 12 semanas</option>
                        <option value="monthly">√öltimos 6 meses</option>
                        <option value="quarterly">√öltimos 4 trimestres</option>
                    </select>
                    <button onclick="exportTrends()" style="margin-left: 10px; padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">üìÅ Exportar CSV</button>
                </div>
                <div class="chart-container" style="height: 400px;">
                    <canvas id="trendsChart"></canvas>
                </div>
                <div id="trend-insights" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <!-- Insights de tendencias se cargar√°n aqu√≠ -->
                </div>
            </div>

            <!-- Comparaci√≥n de Per√≠odos -->
            <div class="dashboard-grid">
                <div class="card">
                    <h3>
                        ‚öñÔ∏è Comparaci√≥n de Per√≠odos
                        <span class="help-icon" data-tooltip="Compara m√©tricas entre dos per√≠odos espec√≠ficos para evaluar mejoras o deterioros. √ötil para medir impacto de cambios organizacionales.">?</span>
                    </h3>
                    <div style="margin-bottom: 15px;">
                        <label>Per√≠odo 1:</label>
                        <input type="date" id="period1-start" style="margin: 5px;">
                        <input type="date" id="period1-end" style="margin: 5px;">
                        <br>
                        <label>Per√≠odo 2:</label>
                        <input type="date" id="period2-start" style="margin: 5px;">
                        <input type="date" id="period2-end" style="margin: 5px;">
                        <br>
                        <button onclick="comparePeriods()" style="margin-top: 10px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer;">üîç Comparar</button>
                    </div>
                    <div id="period-comparison" style="min-height: 200px;">
                        <p style="text-align: center; color: #666; padding: 50px;">Selecciona dos per√≠odos para comparar</p>
                    </div>
                </div>

                <div class="card">
                    <h3>üìà Distribuci√≥n de Sentimientos</h3>
                    <div class="chart-container">
                        <canvas id="sentimentChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <h3>üï∏Ô∏è Red de Colaboraci√≥n</h3>
                    <div class="chart-container">
                        <canvas id="collaborationChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Miembros del equipo -->
            <div class="card">
                <h3>üë• Miembros del Equipo</h3>
                <div id="team-members" class="member-grid">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>

            <!-- Alertas y recomendaciones -->
            <div id="recommendations-container">
                <!-- Se llenar√°n din√°micamente -->
            </div>

            <!-- Silos de conocimiento -->
            <div id="silos-container">
                <!-- Se llenar√°n din√°micamente -->
            </div>
        </div>
    </div>

    <script>
        let sentimentChart = null;
        let collaborationChart = null;
        let trendsChart = null;
        let currentTrendsData = null;

        async function loadData() {
            try {
                const response = await fetch('/api/data');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                updateDashboard(data);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                showError('Error cargando datos del an√°lisis');
            }
        }

        function updateDashboard(data) {
            updateSummaryMetrics(data.summary || {});
            updateSentimentAnalysis(data.sentiment_analysis || {});
            updateCollaborationAnalysis(data.collaboration_analysis || {});
            updateTeamMembers(data.collaboration_analysis?.member_metrics || []);
            updateRecommendations(data.recommendations || []);
            updateKnowledgeSilos(data.collaboration_analysis?.knowledge_silos || []);
        }

        function updateSummaryMetrics(summary) {
            const healthElement = document.getElementById('overall-health');
            const healthStatus = summary.health_status || 'üòê Regular';
            const healthScore = summary.overall_team_health || 0;
            
            healthElement.textContent = healthStatus;
            healthElement.className = 'metric-large ' + getHealthClass(healthScore);
            
            document.getElementById('communication-score').textContent = 
                (summary.communication_health || 0).toFixed(2);
            document.getElementById('collaboration-score').textContent = 
                (summary.collaboration_health || 0).toFixed(2);
            document.getElementById('knowledge-score').textContent = 
                (summary.knowledge_distribution || 0).toFixed(2);
        }

        function updateSentimentAnalysis(sentimentData) {
            const metrics = sentimentData.overall_metrics || {};
            
            document.getElementById('positive-ratio').textContent = 
                ((metrics.positive_ratio || 0) * 100).toFixed(1) + '%';
            document.getElementById('negative-ratio').textContent = 
                ((metrics.negative_ratio || 0) * 100).toFixed(1) + '%';
            
            // Crear gr√°fico de sentimientos
            createSentimentChart(metrics);
        }

        function updateCollaborationAnalysis(collaborationData) {
            const teamMetrics = collaborationData.team_health_metrics || {};
            const networkMetrics = collaborationData.collaboration_network || {};
            
            document.getElementById('team-size').textContent = 
                teamMetrics.team_size || '0';
            document.getElementById('network-density').textContent = 
                (networkMetrics.network_density || 0).toFixed(2);
            document.getElementById('review-participation').textContent = 
                ((teamMetrics.review_participation_rate || 0) * 100).toFixed(1) + '%';
            document.getElementById('silos-count').textContent = 
                (collaborationData.knowledge_silos || []).length;
        }

        function updateTeamMembers(memberMetrics) {
            const container = document.getElementById('team-members');
            container.innerHTML = '';
            
            memberMetrics.forEach(member => {
                const memberCard = document.createElement('div');
                memberCard.className = 'member-card';
                
                const healthClass = getHealthClass(member.collaboration_score);
                
                memberCard.innerHTML = `
                    <div class="member-name">
                        <span class="status-indicator ${getStatusClass(member.collaboration_score)}"></span>
                        ${member.member}
                    </div>
                    <div class="member-stats">
                        <div>Score de Colaboraci√≥n: <strong>${member.collaboration_score.toFixed(2)}</strong></div>
                        <div>Commits: <strong>${member.commits_count}</strong></div>
                        <div>PRs: <strong>${member.pr_count}</strong></div>
                        <div>Reviews: <strong>${member.reviews_given}</strong></div>
                    </div>
                `;
                
                container.appendChild(memberCard);
            });
        }

        function updateRecommendations(recommendations) {
            const container = document.getElementById('recommendations-container');
            container.innerHTML = '';
            
            if (recommendations.length > 0) {
                const recDiv = document.createElement('div');
                recDiv.className = 'recommendations';
                
                let html = '<h3>üí° Recomendaciones</h3><ul>';
                recommendations.forEach(rec => {
                    html += `<li>${rec.message}</li>`;
                });
                html += '</ul>';
                
                recDiv.innerHTML = html;
                container.appendChild(recDiv);
            }
        }

        function updateKnowledgeSilos(silos) {
            const container = document.getElementById('silos-container');
            container.innerHTML = '';
            
            if (silos.length > 0) {
                const silosDiv = document.createElement('div');
                silosDiv.className = 'warning';
                
                let html = '<h3>üö® Silos de Conocimiento Detectados</h3>';
                html += `<p>Se detectaron ${silos.length} silos de conocimiento:</p><ul>`;
                
                silos.forEach(silo => {
                    html += `<li><strong>${silo.primary_owner}</strong>: ${silo.files.length} archivos (${(silo.ownership_percentage * 100).toFixed(1)}% ownership) - Riesgo: ${silo.risk_level}</li>`;
                });
                html += '</ul>';
                
                silosDiv.innerHTML = html;
                container.appendChild(silosDiv);
            }
        }

        function createSentimentChart(metrics) {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            
            if (sentimentChart) {
                sentimentChart.destroy();
            }
            
            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positivo', 'Neutral', 'Negativo'],
                    datasets: [{
                        data: [
                            (metrics.positive_ratio || 0) * 100,
                            (metrics.neutral_ratio || 0) * 100,
                            (metrics.negative_ratio || 0) * 100
                        ],
                        backgroundColor: ['#27ae60', '#95a5a6', '#e74c3c'],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function getHealthClass(score) {
            if (score >= 0.8) return 'excellent';
            if (score >= 0.6) return 'good';
            if (score >= 0.4) return 'fair';
            if (score >= 0.2) return 'poor';
            return 'critical';
        }

        function getStatusClass(score) {
            if (score >= 0.6) return 'status-healthy';
            if (score >= 0.3) return 'status-warning';
            return 'status-critical';
        }

        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard').style.display = 'none';
            loadData();
        }

        function showError(message) {
            document.getElementById('loading').innerHTML = `
                <p style="color: #e74c3c;">‚ùå ${message}</p>
                <button class="refresh-btn" onclick="refreshData()" style="margin-top: 20px;">
                    üîÑ Reintentar
                </button>
            `;
        }

        // Funciones para Tendencias Hist√≥ricas
        async function loadTrendData(period = 'weekly') {
            try {
                const response = await fetch(`/api/trends?period=${period}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error('Error loading trends:', data.error);
                    return;
                }
                
                currentTrendsData = data;
                updateTrendsChart(data);
                updateTrendInsights(data);
                
            } catch (error) {
                console.error('Error loading trend data:', error);
            }
        }

        function updateTrendsChart(trendsData) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }

            // Preparar datos para el gr√°fico
            const labels = trendsData.data_points.map(point => point.date);
            const datasets = [
                {
                    label: 'Salud del Equipo',
                    data: trendsData.data_points.map(point => point.team_health_score),
                    borderColor: '#3498db',
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Sentimiento',
                    data: trendsData.data_points.map(point => point.sentiment_score),
                    borderColor: '#27ae60',
                    backgroundColor: 'rgba(39, 174, 96, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Colaboraci√≥n',
                    data: trendsData.data_points.map(point => point.collaboration_score),
                    borderColor: '#e74c3c',
                    backgroundColor: 'rgba(231, 76, 60, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y'
                },
                {
                    label: 'Commits',
                    data: trendsData.data_points.map(point => point.commit_count),
                    borderColor: '#f39c12',
                    backgroundColor: 'rgba(243, 156, 18, 0.1)',
                    tension: 0.4,
                    yAxisID: 'y1'
                }
            ];

            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: trendsData.period === 'weekly' ? 'Semanas' : 'Meses'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Scores (0.0 - 1.0)'
                            },
                            min: 0,
                            max: 1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'N√∫mero de Commits'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                afterBody: function(tooltipItems) {
                                    const index = tooltipItems[0].dataIndex;
                                    const point = trendsData.data_points[index];
                                    return [
                                        `Contribuidores: ${point.contributor_count}`,
                                        `Tama√±o promedio commit: ${point.avg_commit_size} l√≠neas`
                                    ];
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendInsights(trendsData) {
            const container = document.getElementById('trend-insights');
            
            if (!trendsData.insights || trendsData.insights.length === 0) {
                container.innerHTML = '<p style="color: #666;">No hay suficientes datos para generar insights de tendencias.</p>';
                return;
            }

            let html = '<h4>üìã Insights de Tendencias</h4><ul>';
            trendsData.insights.forEach(insight => {
                html += `<li>${insight}</li>`;
            });
            html += '</ul>';

            // Agregar resumen de cambios
            if (trendsData.trends) {
                html += '<h4>üìä Cambios Clave</h4><div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin-top: 10px;">';
                
                Object.entries(trendsData.trends).forEach(([metric, change]) => {
                    if (Math.abs(change) > 1) { // Solo mostrar cambios significativos
                        const direction = change > 0 ? 'üìà' : 'üìâ';
                        const color = change > 0 ? '#27ae60' : '#e74c3c';
                        const metricNames = {
                            'team_health_score': 'Salud General',
                            'sentiment_score': 'Sentimiento',
                            'collaboration_score': 'Colaboraci√≥n',
                            'activity_score': 'Actividad'
                        };
                        
                        html += `<div style="padding: 8px; background: white; border-radius: 5px; border-left: 3px solid ${color};">
                            <strong>${direction} ${metricNames[metric] || metric}</strong><br>
                            <span style="color: ${color};">${change > 0 ? '+' : ''}${change.toFixed(1)}%</span>
                        </div>`;
                    }
                });
                html += '</div>';
            }

            container.innerHTML = html;
        }

        function updateTrendPeriod() {
            const period = document.getElementById('trend-period').value;
            loadTrendData(period);
        }

        async function comparePeriods() {
            const period1Start = document.getElementById('period1-start').value;
            const period1End = document.getElementById('period1-end').value;
            const period2Start = document.getElementById('period2-start').value;
            const period2End = document.getElementById('period2-end').value;

            if (!period1Start || !period1End || !period2Start || !period2End) {
                alert('Por favor selecciona todas las fechas para comparar');
                return;
            }

            try {
                const response = await fetch('/api/compare-periods', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        period1_start: period1Start,
                        period1_end: period1End,
                        period2_start: period2Start,
                        period2_end: period2End
                    })
                });

                const comparison = await response.json();
                
                if (comparison.error) {
                    alert('Error en la comparaci√≥n: ' + comparison.error);
                    return;
                }

                displayPeriodComparison(comparison);
                
            } catch (error) {
                console.error('Error comparing periods:', error);
                alert('Error al comparar per√≠odos');
            }
        }

        function displayPeriodComparison(comparison) {
            const container = document.getElementById('period-comparison');
            
            const metricNames = {
                'team_health_score': 'Salud General',
                'sentiment_score': 'Sentimiento',
                'collaboration_score': 'Colaboraci√≥n',
                'activity_score': 'Actividad',
                'commit_count': 'N√∫mero de Commits',
                'contributor_count': 'Contribuidores'
            };

            let html = '<h4>üìä Comparaci√≥n de Per√≠odos</h4>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px;">';

            Object.entries(comparison).forEach(([metric, change]) => {
                const direction = change > 0 ? 'üìà' : change < 0 ? 'üìâ' : '‚û°Ô∏è';
                let color = '#6c757d';
                if (Math.abs(change) > 5) {
                    color = change > 0 ? '#27ae60' : '#e74c3c';
                } else if (Math.abs(change) > 2) {
                    color = change > 0 ? '#28a745' : '#ffc107';
                }

                html += `<div style="padding: 15px; background: white; border-radius: 8px; border-left: 4px solid ${color}; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="font-weight: bold; margin-bottom: 5px;">${direction} ${metricNames[metric] || metric}</div>
                    <div style="font-size: 1.2em; color: ${color}; font-weight: bold;">
                        ${change > 0 ? '+' : ''}${change.toFixed(1)}%
                    </div>
                </div>`;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function exportTrends() {
            if (!currentTrendsData) {
                alert('No hay datos de tendencias para exportar');
                return;
            }

            // Crear CSV
            let csv = 'fecha,salud_equipo,sentimiento,colaboracion,actividad,commits,contribuidores,tamano_promedio_commit\n';
            
            currentTrendsData.data_points.forEach(point => {
                csv += `${point.date},${point.team_health_score},${point.sentiment_score},${point.collaboration_score},${point.activity_score},${point.commit_count},${point.contributor_count},${point.avg_commit_size}\n`;
            });

            // Descargar archivo
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tendencias_empathy_${currentTrendsData.period}_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Cargar datos al inicializar
        window.addEventListener('load', function() {
            loadData();
            loadTrendData('weekly'); // Cargar tendencias por defecto
        });
    </script>
</body>
</html>